<!DOCTYPE html>
<html>
<head>
	<title>Prototype - Samenwerkingsvisualisatie</title>
	<link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet">
	<style>
		body { margin: 0px; }
		header { background-color: #333; padding: 10px 20px; margin-bottom: 30px;}
		h1, h2, p, div { font-family: 'Open Sans', sans-serif; font-weight: 300; margin: 0px; color: #8E8E93; }
	
		#container { width: 90%; margin: 0 auto; }
			.left { float: left; width: 20%; padding: 20px 0px 0px 0px; }

                .user { position: relative; }
				.user h2 { position: absolute; top: 10px; left: 100px; }
				.user p.xp { position: absolute; bottom: 15px; left: 35px; color: #fff; font-size: 26px; }
			.center { float: left; width: 50%; }
				#chart { width: 100%; height: 500px; }
			.right { float: left; width: 30%; padding: 20px 0px 0px 0px; overflow: auto; height: 400px}
			
		.clear { clear: both; }
		
		.user { width: 200px; height: 60px; margin: 0px 0px 20px 0px;  }
		.hat-FF2653 { background: url('images/hat-FF2653.png') no-repeat; }
		.hat-3DDA71 { background: url('images/hat-3DDA71.png') no-repeat; }
		.hat-50C9F7 { background: url('images/hat-50C9F7.png') no-repeat; }
		.hat-FFCC38 { background: url('images/hat-FFCC38.png') no-repeat; }
	</style>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
	<header>
		<h1>Prototype - Samenwerkingsvisualisatie</h1>
	</header>
	<div id="container">	
		<div id="users" class="left">
			<h2>&nbsp; Totaal: <span id="xp_total">0</span></h2>
		</div>

		<div class="center">
			<div id="chart"></div>
		</div>

		<div id="log" class="right">
		</div>

		<div class="clear"></div>

	</div>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
	var socket = io.connect('http://localhost');
	
	var users = [
		{ rfid:'3400978DB997', name:"David", xp:10, color:'FF2653', joined: false }, 
		{ rfid:'3400A141D602', name:"Jef", xp:10, color:'3DDA71', joined: false }, 
		{ rfid:'3400888D4E7F', name:"Randy", xp:10, color:'50C9F7', joined: false }
	];

	socket.on('rfid', function(rfid) {
		var stripped = rfid.replace('\r', '').replace('\u0003', '').replace('\u0002', '');
		for(var i in users) {
			if(users[i].rfid == stripped) {
				if(users[i].joined == false) {
					$('#users').prepend('<div id="user-'+users[i].rfid+'" class="user hat-'+users[i].color+'"><h2>'+users[i].name+'</h2><p class="xp">'+users[i].xp+'</p></div>');
					users[i].joined = true;
				} else {
					$('#user-'+users[i].rfid).remove();
					users[i].joined = false;
				}
				calculateTotalXP();
			}
		}
	});
	
	socket.on('viewAngleChanged', function(data) {
		if(users[0].joined) {
			console.log(data);
			data = data.replace('\r', '');
			var msg;
			switch(data) {
				case 'screen':
					msg = ' kijkt naar zijn scherm.';
				break;
				case 'left':
					msg = ' kijkt naar links.';
				break;
				case 'straight':
					msg = ' kijkt voor zich uit.';
				break;
				case 'right':
					msg = ' kijkt naar rechts.';
				break;
			}
			$('#log').prepend('<div><img src="images/hat-'+users[0].color+'.png" width="30" height="10" />'+users[0].name+msg+'</div>');
		}
	});

	socket.on('soundChanged', function(data) {
		if(users[0].joined) {
			data = data.replace('\r', '');
			console.log(data);
			if(data == 'nottalking') {
				$('#log').prepend('<div><img src="images/hat-'+users[0].color+'.png" width="30" height="10" />'+users[0].name+' is aan het woord geweest.</div>');
				updateUserXp(users[0]);
				calculateTotalXP();
			}
		}
	});

	function updateUserXp(user) {
		user.xp += 10;
		$('#user-'+user.rfid+' .xp').html(user.xp);
	}

	function calculateTotalXP() {
		var XPtotal = 0;
		for(var i in users) {
			if(users[i].joined == true) {
				XPtotal = XPtotal + users[i].xp;
			}
		}
		$('#xp_total').html(XPtotal);
	}
	</script>
</body>
</html>